<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consumer Behavior Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6; /* Light background */
            color: #1f2937; /* Dark text */
        }
        /* Custom styles for chart */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
        /* Custom styles for table scrollbar */
        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 20px;
            border: 3px solid #e5e7eb;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Dashboard ข้อมูลพฤติกรรมผู้บริโภค</h1>
            <p class="text-lg text-gray-600 mt-2">ภาพรวมข้อมูลเชิงลึกจากลูกค้า (Live from Google Sheet)</p>
        </header>
        
        <div id="loading-state" class="text-center text-gray-600 mb-8">
            <p>กำลังโหลดข้อมูลจาก Google Sheet...</p>
        </div>
        
        <div id="error-state" class="hidden text-center text-red-700 bg-red-100 p-4 rounded-lg mb-8">
            <p>ไม่สามารถโหลดข้อมูลได้ โปรดตรวจสอบว่า Google Sheet ID ถูกต้อง และตั้งค่าการแชร์เป็น "ทุกคนที่มีลิงก์"</p>
        </div>


        <!-- Main Grid Layout - Initially hidden -->
        <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 opacity-0 transition-opacity duration-700">
            <!-- Card: Total Users -->
            <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-center items-center">
                <h2 class="text-lg font-semibold text-gray-500">จำนวนผู้ใช้งานทั้งหมด</h2>
                <p id="total-users" class="text-5xl font-bold text-cyan-500 mt-2">0</p>
            </div>

            <!-- Card: Average Satisfaction -->
            <div class="bg-white p-6 rounded-xl shadow-lg flex flex-col justify-center items-center">
                <h2 class="text-lg font-semibold text-gray-500">ความพึงพอใจเฉลี่ย</h2>
                <p id="avg-satisfaction" class="text-5xl font-bold text-green-500 mt-2">0.0</p>
            </div>

            <!-- Chart: Platform Usage -->
            <div class="bg-white p-6 rounded-xl shadow-lg col-span-1 md:col-span-2">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 text-center">จำนวนผู้ใช้งานในแต่ละแพลตฟอร์ม</h2>
                <div class="chart-container">
                    <canvas id="platform-chart"></canvas>
                </div>
            </div>

            <!-- Table: All Data -->
            <div class="bg-white p-6 rounded-xl shadow-lg col-span-1 md:col-span-2 lg:col-span-4">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-gray-900">ข้อมูลทั้งหมด</h2>
                    <input type="text" id="table-filter" placeholder="ค้นหาในตาราง..." class="w-full md:w-1/3 p-2 rounded-lg bg-gray-100 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                </div>
                <div class="table-container overflow-x-auto overflow-y-auto max-h-[500px]">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr>
                                <!-- Table headers will be generated dynamically -->
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="divide-y divide-gray-200">
                            <!-- Table rows will be generated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const dashboardContent = document.getElementById('dashboard-content');
            let platformChartInstance = null; // To hold the chart instance

            async function loadDataFromGoogleSheet() {
                const sheetId = '1O1VThErd-oVfz-QbTOSnqtMdUge9fXmcqkf1X1Trk7w';
                const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;

                try {
                    const response = await fetch(sheetURL);
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.statusText}`);
                    }
                    const csvText = await response.text();
                    const data = parseCSV(csvText);
                    
                    populateDashboard(data);

                    loadingState.classList.add('hidden');
                    dashboardContent.classList.remove('opacity-0');
                } catch (error) {
                    console.error("Error fetching or processing Google Sheet data:", error);
                    loadingState.classList.add('hidden');
                    errorState.classList.remove('hidden');
                }
            }
            
            function parseCSV(text) {
                const lines = text.trim().split(/\r?\n/);
                if (lines.length < 2) throw new Error("CSV must have a header and at least one data row.");

                const headers = lines[0].split(',').map(h => h.trim());
                const rows = lines.slice(1).map(line => {
                    const values = line.split(',').map(v => v.trim());
                    if (values.length !== headers.length) {
                        console.warn("Skipping malformed row:", line);
                        return null;
                    }
                    let obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = values[i];
                    });
                    return obj;
                }).filter(row => row !== null);
                return rows;
            }

            function populateDashboard(data) {
                populateCards(data);
                createPlatformChart(data);
                createDataTable(data);
            }

            function populateCards(data) {
                const totalUsers = data.length;
                document.getElementById('total-users').innerText = totalUsers.toLocaleString();

                const totalSatisfaction = data.reduce((sum, row) => sum + parseFloat(row.satisfaction_score || 0), 0);
                const avgSatisfaction = totalUsers > 0 ? (totalSatisfaction / totalUsers).toFixed(1) : 0.0;
                document.getElementById('avg-satisfaction').innerText = avgSatisfaction;
            }

            function createPlatformChart(data) {
                if (platformChartInstance) {
                    platformChartInstance.destroy();
                }
                const platformCounts = data.reduce((acc, row) => {
                    const platform = row.preferred_platform;
                    if (platform) {
                        acc[platform] = (acc[platform] || 0) + 1;
                    }
                    return acc;
                }, {});

                const ctx = document.getElementById('platform-chart').getContext('2d');
                platformChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(platformCounts),
                        datasets: [{
                            label: 'จำนวนผู้ใช้งาน',
                            data: Object.values(platformCounts),
                            backgroundColor: [
                                'rgba(14, 165, 233, 0.6)', 'rgba(16, 185, 129, 0.6)',
                                'rgba(245, 158, 11, 0.6)', 'rgba(239, 68, 68, 0.6)',
                                'rgba(139, 92, 246, 0.6)', 'rgba(249, 115, 22, 0.6)'
                            ],
                            borderColor: [
                                'rgba(14, 165, 233, 1)', 'rgba(16, 185, 129, 1)',
                                'rgba(245, 158, 11, 1)', 'rgba(239, 68, 68, 1)',
                                'rgba(139, 92, 246, 1)', 'rgba(249, 115, 22, 1)'
                            ],
                            borderWidth: 1,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#4b5563' }, grid: { color: '#d1d5db' } },
                            x: { ticks: { color: '#4b5563' }, grid: { color: '#e5e7eb' } }
                        }
                    }
                });
            }

            function createDataTable(data) {
                if (data.length === 0) return;

                const tableHead = document.querySelector('thead tr');
                const tableBody = document.getElementById('data-table-body');
                const headers = Object.keys(data[0]);

                tableHead.innerHTML = headers.map(header => `<th class="p-3 text-sm font-semibold tracking-wide text-left text-gray-700">${header.replace(/_/g, ' ').toUpperCase()}</th>`).join('');

                let rowsHtml = '';
                data.forEach(row => {
                    rowsHtml += '<tr class="hover:bg-gray-100">';
                    headers.forEach(header => {
                        rowsHtml += `<td class="p-3 text-sm text-gray-700">${row[header]}</td>`;
                    });
                    rowsHtml += '</tr>';
                });
                tableBody.innerHTML = rowsHtml;
                
                const filterInput = document.getElementById('table-filter');
                filterInput.addEventListener('keyup', () => {
                    const filterText = filterInput.value.toLowerCase();
                    const tableRows = tableBody.getElementsByTagName('tr');
                    
                    Array.from(tableRows).forEach(row => {
                        const rowText = row.textContent.toLowerCase();
                        row.style.display = rowText.includes(filterText) ? '' : 'none';
                    });
                });
            }

            // Load data from Google Sheet when the page loads
            loadDataFromGoogleSheet();
        });
    </script>
</body>
</html>

